# Lab 02: Service Exploitation

**Skill Level**: Intermediate [I]

A hands-on exercise in SMB enumeration and service exploitation techniques.

> **Note**: Complete Lab 01 before attempting this lab.

---

## Lab Information

| Attribute | Value |
|-----------|-------|
| Difficulty | Intermediate |
| Time Estimate | 60-90 minutes |
| Prerequisites | Lab 01 completed, Network Scanner Walkthrough |
| Tools Required | smb-enumerator, service-fingerprinter, http-request-tool |

## Prerequisites Checklist

Before starting, ensure you:

- [ ] Completed Lab 01: Network Reconnaissance
- [ ] Understand how to run port scans
- [ ] Know what SMB is (Windows file sharing protocol - see [Glossary](../GLOSSARY.md))
- [ ] Have basic familiarity with HTTP requests

**Key Terms for This Lab**: SMB, Null Session, Enumeration, HTTP Basic Auth, Virtual Host (see [Glossary](../GLOSSARY.md))

---

## Objective

Leverage reconnaissance data to enumerate services in depth and identify potential exploitation vectors. Focus on SMB enumeration, HTTP service analysis, and identifying misconfigurations.

---

## Environment Setup

### Lab Network (continued from Lab 01)

```
Network: 10.10.10.0/24
File Server: 10.10.10.30 (SMB shares)
Web Server: 10.10.10.20 (HTTP services)
Domain Controller: 10.10.10.10 (SMB, LDAP)
Domain: corp.local
```

### Discovered Services (from Lab 01)

| Host | Service | Port |
|------|---------|------|
| 10.10.10.10 | SMB | 445 |
| 10.10.10.20 | HTTP | 80, 8080 |
| 10.10.10.30 | SMB | 445 |
| 10.10.10.30 | FTP | 21 |

---

## Scenario

You have completed initial reconnaissance of CorpTech Industries. Now you need to enumerate services in depth to identify:
- Accessible file shares
- Web application entry points
- Service misconfigurations
- Potential credential storage locations

---

## Tasks

### Task 1: SMB Enumeration - Null Session (Level 1 - Foundation)

**Objective**: Enumerate SMB shares using null session (anonymous) authentication.

**Instructions**:

1. Preview the SMB enumeration:
```bash
python3 /path/to/smb-enumerator/tool.py 10.10.10.30 --plan
```

2. Perform null session enumeration:
```bash
python3 /path/to/smb-enumerator/tool.py 10.10.10.30 \
    --null-session \
    --verbose \
    --output task1_smb_30.json
```

3. Enumerate the domain controller:
```bash
python3 /path/to/smb-enumerator/tool.py 10.10.10.10 \
    --null-session \
    --verbose \
    --output task1_smb_10.json
```

4. Document discovered shares and their permissions.

**Deliverable**: SMB share inventory with access levels

**Validation**: Identify at least 3 accessible shares.

---

### Task 2: SMB Enumeration - System Information (Level 1 - Foundation)

**Objective**: Extract system information via SMB.

**Instructions**:

1. For each SMB host, document:
   - Operating system version
   - SMB version
   - Domain membership
   - Signing requirements

**Template**:
```
Host: 10.10.10.30
OS: [detected version]
SMB Version: [version]
Domain: [domain name]
Signing: [required/not required]
```

**Deliverable**: System information for all SMB hosts

**Validation**: Identify the Windows version on at least 2 hosts.

---

### Task 3: Web Service Enumeration (Level 2 - Application)

**Objective**: Enumerate web services and identify attack vectors.

**Instructions**:

1. Use the HTTP request tool to probe web services:
```bash
python3 /path/to/http-request-tool/tool.py \
    --url http://10.10.10.20/ \
    --method GET \
    --verbose
```

2. Check for common paths:
```bash
# Check each path
for path in robots.txt admin login wp-admin phpmyadmin; do
    python3 /path/to/http-request-tool/tool.py \
        --url http://10.10.10.20/$path \
        --method GET
done
```

3. Use the web directory enumerator:
```bash
python3 /path/to/web-directory-enumerator/tool.py \
    --url http://10.10.10.20 \
    --wordlist /path/to/wordlist.txt \
    --verbose \
    --output task3_dirs.json
```

4. Document all discovered endpoints.

**Deliverable**: Web application map with discovered paths

**Validation**: Discover at least 5 valid web paths.

---

### Task 4: Service Version Vulnerability Mapping (Level 2 - Application)

**Objective**: Map discovered service versions to potential vulnerabilities.

**Instructions**:

1. Review service versions from fingerprinting:
```bash
python3 /path/to/service-fingerprinter/tool.py 10.10.10.20 \
    --ports 80,8080 \
    --aggressive \
    --verbose
```

2. For each service version, research potential vulnerabilities:
   - Check CVE databases
   - Search exploit databases
   - Note default credentials

3. Create a vulnerability mapping document.

**Template**:
```
Service: Apache 2.4.41
CVEs: CVE-20XX-XXXX (description)
Exploits: [list any known exploits]
Default Creds: [if applicable]
Risk Level: High/Medium/Low
```

**Deliverable**: Vulnerability mapping document

---

### Task 5: Sensitive Data Discovery (Level 3 - Integration)

**Objective**: Search for sensitive data in accessible locations.

**Instructions**:

1. If SMB shares are accessible, look for:
   - Configuration files
   - Backup files
   - Scripts with credentials
   - Documentation with passwords

2. On web services, look for:
   - Exposed configuration files
   - Backup files (.bak, .old, ~)
   - Information disclosure

3. Document any sensitive information found.

**Warning**: In real engagements, handle discovered sensitive data according to ROE.

**Deliverable**: Sensitive data discovery report

---

### Task 6: Attack Vector Prioritization (Level 3 - Integration)

**Objective**: Prioritize exploitation vectors based on findings.

**Instructions**:

Using all gathered information, create a prioritized attack plan:

1. Rank each potential attack vector by:
   - Likelihood of success
   - Potential impact
   - Required skill level
   - Detection risk

2. Create exploitation priority list.

**Template**:
```
# Attack Vector Prioritization

## Priority 1: [Vector Name]
- Target: [IP/Service]
- Method: [Brief description]
- Success Likelihood: High/Medium/Low
- Impact: High/Medium/Low
- Detection Risk: High/Medium/Low
- Required: [Tools/Exploits needed]

## Priority 2: [Vector Name]
...
```

**Deliverable**: Prioritized attack plan document

---

## Challenge Tasks (Level 4 - Mastery)

### Challenge 1: Authenticated SMB Enumeration

If you discovered valid credentials in previous tasks, perform authenticated enumeration:
```bash
python3 /path/to/smb-enumerator/tool.py 10.10.10.30 \
    -u <username> \
    -P <password> \
    -d corp.local \
    --verbose
```

Compare results with null session enumeration.

### Challenge 2: Hidden Virtual Hosts

The web server may be hosting multiple sites. Enumerate virtual hosts:
```bash
# Test common vhost names
for vhost in dev staging test admin; do
    python3 /path/to/http-request-tool/tool.py \
        --url http://10.10.10.20 \
        --headers "Host: $vhost.corp.local" \
        --verbose
done
```

### Challenge 3: Protocol-Specific Enumeration

Enumerate the FTP service on 10.10.10.30:
- Check for anonymous access
- List accessible files
- Document version and configuration

---

## Hints

<details>
<summary>Hint 1: SMB Null Session Denied</summary>

Modern Windows systems often block null sessions. Check if specific shares are still accessible:
- IPC$ is often accessible even when others are not
- Try guest access if null session fails
</details>

<details>
<summary>Hint 2: No Web Directories Found</summary>

Try different wordlists or check for:
- Case sensitivity
- File extensions (.php, .html, .asp)
- Different response codes (200, 301, 302, 401, 403)
</details>

<details>
<summary>Hint 3: Service Fingerprint Inconclusive</summary>

Try alternative methods:
- Banner grabbing directly
- Different ports for same service
- Protocol-specific probes
</details>

<details>
<summary>Hint 4: SMB Signing</summary>

If SMB signing is "Not Required", note this as it enables:
- SMB relay attacks
- Man-in-the-middle attacks
- Credential capture
</details>

---

## Solution Guide

<details>
<summary>Click to reveal solution (Instructor Use)</summary>

### Task 1 Solution

```bash
# File server enumeration
python3 /path/to/smb-enumerator/tool.py 10.10.10.30 --null-session --verbose

# Expected output:
# Shares: IPC$, SYSVOL, NETLOGON, Public, IT_Backup
# Public: Read access
# IT_Backup: Read access (misconfiguration!)
```

### Task 2 Solution

Expected findings:
- 10.10.10.10: Windows Server 2019, SMB3, Signing Required
- 10.10.10.30: Windows Server 2016, SMB2+, Signing NOT Required (vulnerability!)

### Task 3 Solution

```bash
# Directory enumeration results:
# /admin - 401 (auth required)
# /backup - 200 (directory listing!)
# /phpmyadmin - 200 (database interface)
# /config.php.bak - 200 (exposed config backup!)
```

### Task 4 Solution

Vulnerability mapping example:
- Apache 2.4.41: CVE-2021-41773 (path traversal)
- PHP 7.4: Multiple CVEs depending on exact version
- SMB without signing: Relay attack possible

### Task 5 Solution

Sensitive data locations:
- SMB IT_Backup share: backup scripts with database credentials
- Web /backup: database dumps
- config.php.bak: MySQL credentials

</details>

---

## Assessment Criteria

| Criteria | Points | Description |
|----------|--------|-------------|
| SMB Enumeration | 25 | Complete share inventory |
| System Information | 15 | OS and configuration details |
| Web Enumeration | 20 | Paths and endpoints discovered |
| Vulnerability Mapping | 20 | Accurate CVE research |
| Attack Prioritization | 20 | Well-reasoned priority list |

**Total: 100 points**

---

## Security Notes

### What You Learned About Defense

From an attacker's perspective, you've seen:
- Why null session access should be disabled
- Why SMB signing should be required
- Why backup files shouldn't be web-accessible
- Why directory listing should be disabled

Document these as remediation recommendations.

---

## Cleanup

```bash
# Remove output files
rm -f task*.json

# Clear any cached credentials
# (if you tested with real creds)
```

---

## Next Lab

Proceed to **Lab 03: Credential Attacks** to learn how to validate and crack discovered credentials.
